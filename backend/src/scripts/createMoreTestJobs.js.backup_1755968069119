const { Pool } = require('pg');
const { v4: uuidv4 } = require('uuid');
require('dotenv').config({ path: require('path').join(__dirname, '../../.env') });

const pool = new Pool({
  host: process.env.DB_HOST || 'gz-postgres-peldbckv.sql.tencentcdb.com',
  port: process.env.DB_PORT || 23309,
  database: process.env.DB_NAME || 'blue_collar_platform',
  user: process.env.DB_USER || 'staffLink',
  password: process.env.DB_PASSWORD || 'SkzgEBg-23YbBpc',
  ssl: {
    rejectUnauthorized: false
  }
});

async function createMoreJobs() {
  try {
    console.log('ğŸ¯ åˆ›å»ºæ›´å¤šæµ‹è¯•å·¥ä½œè®°å½•...\n');

    // 1. è·å–æµ‹è¯•å·¥äººè´¦å· (æå¸ˆå‚…)
    const workerResult = await pool.query(`
      SELECT id, name, phone 
      FROM workers 
      WHERE phone = '13800138002'
    `);
    
    const worker = workerResult.rows[0];
    console.log('ğŸ‘· ä¸ºå·¥äººåˆ›å»ºæ›´å¤šå·¥ä½œè®°å½•:', worker.name);

    // 2. è·å–æµ‹è¯•å…¬å¸
    const companyResult = await pool.query(`
      SELECT id, company_name 
      FROM companies 
      LIMIT 1
    `);
    
    const company = companyResult.rows[0];

    // 3. è·å–æµ‹è¯•é¡¹ç›®
    const projectResult = await pool.query(`
      SELECT id, project_name 
      FROM projects 
      LIMIT 2
    `);
    
    const projects = projectResult.rows;

    // å¼€å§‹äº‹åŠ¡
    await pool.query('BEGIN');

    // 4. åˆ›å»ºä¸€ä¸ª"å·²åˆ°è¾¾"çŠ¶æ€çš„å·¥ä½œè®°å½•
    const arrivedJobId = uuidv4();
    const arrivedInvitationId = uuidv4();
    
    // å…ˆåˆ›å»ºé‚€è¯·
    await pool.query(`
      INSERT INTO invitations (
        id, project_id, worker_id, company_id,
        wage_offer, wage_type, start_date, end_date,
        start_time, end_time, message, status,
        created_at, updated_at
      ) VALUES (
        $1, $2, $3, $4, 300, 'hourly',
        CURRENT_DATE, CURRENT_DATE + INTERVAL '1 day',
        '14:00', '22:00', 'ä¸‹åˆç­ç”µå·¥ä½œä¸š', 'accepted',
        NOW(), NOW()
      )
    `, [arrivedInvitationId, projects[0].id, worker.id, company.id]);

    // åˆ›å»ºå·²åˆ°è¾¾çš„å·¥ä½œè®°å½•
    await pool.query(`
      INSERT INTO job_records (
        id, invitation_id, project_id, worker_id, company_id,
        status, payment_amount, payment_type, work_date,
        arrival_time, arrival_latitude, arrival_longitude,
        created_at, updated_at
      ) VALUES (
        $1, $2, $3, $4, $5,
        'arrived', 300, 'hourly', CURRENT_DATE,
        NOW(), 31.2304, 121.4737,
        NOW(), NOW()
      )
    `, [arrivedJobId, arrivedInvitationId, projects[0].id, worker.id, company.id]);

    console.log('âœ… åˆ›å»º"å·²åˆ°è¾¾"çŠ¶æ€çš„å·¥ä½œè®°å½•');

    // 5. åˆ›å»ºä¸€ä¸ª"å·¥ä½œä¸­"çŠ¶æ€çš„å·¥ä½œè®°å½•
    const workingJobId = uuidv4();
    const workingInvitationId = uuidv4();
    
    // å…ˆåˆ›å»ºé‚€è¯·
    await pool.query(`
      INSERT INTO invitations (
        id, project_id, worker_id, company_id,
        wage_offer, wage_type, start_date, end_date,
        start_time, end_time, message, status,
        created_at, updated_at
      ) VALUES (
        $1, $2, $3, $4, 350, 'hourly',
        CURRENT_DATE, CURRENT_DATE,
        '09:00', '18:00', 'æ°´ç®¡ç»´ä¿®å·¥ä½œ', 'accepted',
        NOW() - INTERVAL '2 hours', NOW()
      )
    `, [workingInvitationId, projects[1] ? projects[1].id : projects[0].id, worker.id, company.id]);

    // åˆ›å»ºå·¥ä½œä¸­çš„è®°å½•
    await pool.query(`
      INSERT INTO job_records (
        id, invitation_id, project_id, worker_id, company_id,
        status, payment_amount, payment_type, work_date,
        arrival_time, arrival_latitude, arrival_longitude,
        start_work_time,
        created_at, updated_at
      ) VALUES (
        $1, $2, $3, $4, $5,
        'working', 350, 'hourly', CURRENT_DATE,
        NOW() - INTERVAL '1 hour', 31.2304, 121.4737,
        NOW() - INTERVAL '30 minutes',
        NOW() - INTERVAL '2 hours', NOW()
      )
    `, [workingJobId, workingInvitationId, projects[1] ? projects[1].id : projects[0].id, worker.id, company.id]);

    console.log('âœ… åˆ›å»º"å·¥ä½œä¸­"çŠ¶æ€çš„å·¥ä½œè®°å½•');

    // æäº¤äº‹åŠ¡
    await pool.query('COMMIT');
    console.log('\nğŸ‰ æˆåŠŸåˆ›å»ºæ›´å¤šæµ‹è¯•å·¥ä½œè®°å½•ï¼');

    // 6. éªŒè¯æ•°æ®
    console.log('\nğŸ“Š å½“å‰æ•°æ®ç»Ÿè®¡:');
    
    // æ£€æŸ¥å„çŠ¶æ€çš„å·¥ä½œè®°å½•
    const statusCount = await pool.query(`
      SELECT status, COUNT(*) as count
      FROM job_records
      WHERE worker_id = $1
      GROUP BY status
      ORDER BY status
    `, [worker.id]);
    
    console.log('\nå·¥ä½œè®°å½•çŠ¶æ€åˆ†å¸ƒ:');
    console.table(statusCount.rows);

    // æ˜¾ç¤ºæ‰€æœ‰å·¥ä½œè®°å½•
    const allJobs = await pool.query(`
      SELECT 
        jr.id,
        jr.status,
        jr.payment_amount,
        jr.payment_type,
        p.project_name
      FROM job_records jr
      LEFT JOIN projects p ON jr.project_id = p.id
      WHERE jr.worker_id = $1
      ORDER BY jr.created_at DESC
    `, [worker.id]);
    
    console.log('\næ‰€æœ‰å·¥ä½œè®°å½•:');
    console.table(allJobs.rows);

  } catch (error) {
    await pool.query('ROLLBACK');
    console.error('âŒ é”™è¯¯:', error.message);
  } finally {
    await pool.end();
  }
}

createMoreJobs();