const { Pool } = require('pg');
require('dotenv').config({ path: require('path').join(__dirname, '../../.env') });

const pool = new Pool({
  host: process.env.DB_HOST || 'gz-postgres-peldbckv.sql.tencentcdb.com',
  port: process.env.DB_PORT || 23309,
  database: process.env.DB_NAME || 'blue_collar_platform',
  user: process.env.DB_USER || 'staffLink',
  password: process.env.DB_PASSWORD || 'SkzgEBg-23YbBpc',
  ssl: {
    rejectUnauthorized: false
  }
});

async function createTestNotifications() {
  try {
    console.log('ğŸ”” ä¸ºå¼ å¸ˆå‚…åˆ›å»ºæµ‹è¯•é€šçŸ¥...\n');
    
    // è·å–å¼ å¸ˆå‚…çš„ID (13800138001)
    const worker = await pool.query(
      "SELECT id, name FROM workers WHERE phone = '13800138001'"
    );
    
    if (worker.rows.length === 0) {
      console.log('âŒ æœªæ‰¾åˆ°å¼ å¸ˆå‚…è´¦å·');
      return;
    }
    
    const workerId = worker.rows[0].id;
    const workerName = worker.rows[0].name;
    console.log(`æ‰¾åˆ°å·¥äºº: ${workerName} (ID: ${workerId})`);
    
    // è·å–ä¸€ä¸ªä¼ä¸šè´¦å·
    const company = await pool.query('SELECT id, company_name FROM companies LIMIT 1');
    const companyId = company.rows[0].id;
    const companyName = company.rows[0].company_name;
    
    // åˆ›å»ºå„ç§ç±»å‹çš„é€šçŸ¥
    const notifications = [
      {
        receiver_id: workerId,
        receiver_type: 'worker',
        sender_id: companyId,
        sender_type: 'company',
        type: 'invitation_received',
        title: 'æ–°å·¥ä½œæœºä¼š',
        message: `${companyName}é‚€è¯·æ‚¨å‚ä¸"åŠå…¬æ¥¼è£…ä¿®"é¡¹ç›®ï¼Œæ—¥è–ª350å…ƒ`,
        is_read: false,
        metadata: {
          companyName: companyName,
          projectName: 'åŠå…¬æ¥¼è£…ä¿®',
          wageOffer: 350,
          wageType: 'daily',
          location: 'æœé˜³åŒºå»ºå›½è·¯88å·'
        }
      },
      {
        receiver_id: workerId,
        receiver_type: 'worker',
        sender_id: companyId,
        sender_type: 'company',
        type: 'invitation_received',
        title: 'æ–°å·¥ä½œæœºä¼š',
        message: `${companyName}é‚€è¯·æ‚¨å‚ä¸"æ°´ç”µç»´ä¿®"é¡¹ç›®ï¼Œæ—¶è–ª60å…ƒ`,
        is_read: false,
        metadata: {
          companyName: companyName,
          projectName: 'æ°´ç”µç»´ä¿®',
          wageOffer: 60,
          wageType: 'hourly',
          location: 'æµ·æ·€åŒºä¸­å…³æ‘å¤§è¡—1å·'
        }
      },
      {
        receiver_id: workerId,
        receiver_type: 'worker',
        sender_id: companyId,
        sender_type: 'company',
        type: 'project_started',
        title: 'é¡¹ç›®å³å°†å¼€å§‹',
        message: '"å•†åœºæ”¹é€ "é¡¹ç›®å°†åœ¨ä»Šå¤©ä¸‹åˆ2:00å¼€å§‹ï¼Œè¯·æå‰åˆ°è¾¾ç°åœº',
        is_read: false,
        metadata: {
          projectName: 'å•†åœºæ”¹é€ ',
          startTime: '14:00',
          location: 'ä¸œåŸåŒºç‹åºœäº•å¤§è¡—100å·',
          contact: 'æç»ç† 13900000001'
        }
      },
      {
        receiver_id: workerId,
        receiver_type: 'worker',
        type: 'payment_received',
        title: 'å·¥èµ„åˆ°è´¦é€šçŸ¥',
        message: 'æ‚¨çš„"åœ°æ¿å®‰è£…"é¡¹ç›®å·¥èµ„Â¥2800å·²åˆ°è´¦ï¼Œè¯·æŸ¥æ”¶',
        is_read: false,
        metadata: {
          projectName: 'åœ°æ¿å®‰è£…',
          amount: 2800,
          paymentMethod: 'é“¶è¡Œè½¬è´¦',
          bankAccount: 'å°¾å·8888'
        }
      },
      {
        receiver_id: workerId,
        receiver_type: 'worker',
        sender_id: companyId,
        sender_type: 'company',
        type: 'project_completed',
        title: 'é¡¹ç›®å·²å®Œæˆ',
        message: '"å¨æˆ¿æ”¹é€ "é¡¹ç›®å·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„è¾›å‹¤å·¥ä½œï¼',
        is_read: true,
        metadata: {
          projectName: 'å¨æˆ¿æ”¹é€ ',
          completedAt: new Date().toISOString(),
          rating: 5,
          comment: 'å·¥ä½œè®¤çœŸè´Ÿè´£ï¼ŒæŠ€æœ¯ç²¾æ¹›'
        }
      },
      {
        receiver_id: workerId,
        receiver_type: 'worker',
        type: 'system',
        title: 'ç³»ç»Ÿç»´æŠ¤é€šçŸ¥',
        message: 'ç³»ç»Ÿå°†äºä»Šæ™š23:00-01:00è¿›è¡Œç»´æŠ¤å‡çº§ï¼ŒæœŸé—´å¯èƒ½æ— æ³•ä½¿ç”¨',
        is_read: true,
        metadata: {
          maintenanceType: 'scheduled',
          duration: '2å°æ—¶'
        }
      },
      {
        receiver_id: workerId,
        receiver_type: 'worker',
        sender_id: companyId,
        sender_type: 'company',
        type: 'invitation_cancelled',
        title: 'é‚€è¯·å·²å–æ¶ˆ',
        message: `${companyName}å–æ¶ˆäº†"å¤–å¢™ç²‰åˆ·"é¡¹ç›®çš„é‚€è¯·ï¼Œç»™æ‚¨å¸¦æ¥ä¸ä¾¿æ•¬è¯·è°…è§£`,
        is_read: true,
        metadata: {
          companyName: companyName,
          projectName: 'å¤–å¢™ç²‰åˆ·',
          reason: 'é¡¹ç›®æš‚æ—¶å»¶æœŸ'
        }
      }
    ];
    
    // æ’å…¥é€šçŸ¥
    let successCount = 0;
    for (const notification of notifications) {
      try {
        const insertQuery = `
          INSERT INTO notifications (
            receiver_id, receiver_type, sender_id, sender_type,
            type, title, message, is_read, metadata, created_at
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, 
            CURRENT_TIMESTAMP - INTERVAL '${Math.floor(Math.random() * 48)} hours'
          )
          RETURNING id, title, type, is_read;
        `;
        
        const values = [
          notification.receiver_id,
          notification.receiver_type,
          notification.sender_id || null,
          notification.sender_type || null,
          notification.type,
          notification.title,
          notification.message,
          notification.is_read,
          JSON.stringify(notification.metadata)
        ];
        
        const result = await pool.query(insertQuery, values);
        console.log(`âœ… åˆ›å»ºé€šçŸ¥: ${result.rows[0].title} (${result.rows[0].type}) - ${result.rows[0].is_read ? 'å·²è¯»' : 'æœªè¯»'}`);
        successCount++;
      } catch (error) {
        console.error(`âŒ åˆ›å»ºé€šçŸ¥å¤±è´¥:`, error.message);
      }
    }
    
    // ç»Ÿè®¡ç»“æœ
    const stats = await pool.query(
      `SELECT 
        COUNT(*) as total,
        COUNT(*) FILTER (WHERE is_read = false) as unread
      FROM notifications 
      WHERE receiver_id = $1 AND receiver_type = 'worker'`,
      [workerId]
    );
    
    console.log('\nğŸ“Š ç»Ÿè®¡ç»“æœ:');
    console.log(`${workerName} (13800138001):`);
    console.log(`  - æ€»é€šçŸ¥æ•°: ${stats.rows[0].total}`);
    console.log(`  - æœªè¯»é€šçŸ¥: ${stats.rows[0].unread}`);
    
    console.log('\nğŸ‰ æµ‹è¯•é€šçŸ¥åˆ›å»ºå®Œæˆï¼');
    console.log('ğŸ“± ç°åœ¨å¯ä»¥ç”¨ 13800138001 / 123456 ç™»å½•æŸ¥çœ‹é€šçŸ¥äº†');
    
  } catch (error) {
    console.error('âŒ é”™è¯¯:', error.message);
  } finally {
    await pool.end();
  }
}

// æ‰§è¡Œ
createTestNotifications();