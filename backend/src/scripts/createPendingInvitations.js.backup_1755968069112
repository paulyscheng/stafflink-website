const { Pool } = require('pg');
const { v4: uuidv4 } = require('uuid');
require('dotenv').config({ path: require('path').join(__dirname, '../../.env') });

const pool = new Pool({
  host: process.env.DB_HOST || 'gz-postgres-peldbckv.sql.tencentcdb.com',
  port: process.env.DB_PORT || 23309,
  database: process.env.DB_NAME || 'blue_collar_platform',
  user: process.env.DB_USER || 'staffLink',
  password: process.env.DB_PASSWORD || 'SkzgEBg-23YbBpc',
  ssl: {
    rejectUnauthorized: false
  }
});

async function createPendingInvitations() {
  try {
    console.log('ğŸ“¬ åˆ›å»ºæ–°çš„å¾…å“åº”é‚€è¯·...\n');

    // è·å–å¼ å¸ˆå‚…çš„ä¿¡æ¯
    const worker = await pool.query(
      "SELECT id, name FROM workers WHERE phone = '13800138001'"
    );
    
    if (worker.rows.length === 0) {
      console.log('âŒ æœªæ‰¾åˆ°å¼ å¸ˆå‚…è´¦å·');
      return;
    }
    
    const workerId = worker.rows[0].id;
    const workerName = worker.rows[0].name;
    console.log(`æ‰¾åˆ°å·¥äºº: ${workerName} (ID: ${workerId})`);

    // é¦–å…ˆæ£€æŸ¥ç°æœ‰é‚€è¯·çŠ¶æ€
    const existingInvitations = await pool.query(`
      SELECT status, COUNT(*) as count 
      FROM invitations 
      WHERE worker_id = $1 
      GROUP BY status
      ORDER BY status
    `, [workerId]);
    
    console.log('\nğŸ“Š ç°æœ‰é‚€è¯·çŠ¶æ€:');
    console.table(existingInvitations.rows);

    // è·å–ä¼ä¸šå’Œé¡¹ç›®ä¿¡æ¯
    const company = await pool.query('SELECT id, company_name FROM companies LIMIT 1');
    if (company.rows.length === 0) {
      console.log('âŒ æœªæ‰¾åˆ°ä¼ä¸šè´¦å·');
      return;
    }
    
    const companyId = company.rows[0].id;
    const companyName = company.rows[0].company_name;

    // è·å–é¡¹ç›®ä¿¡æ¯
    const projects = await pool.query(
      'SELECT id, project_name, start_date FROM projects WHERE company_id = $1 LIMIT 5',
      [companyId]
    );

    if (projects.rows.length === 0) {
      console.log('âŒ æœªæ‰¾åˆ°é¡¹ç›®');
      return;
    }

    // åˆ›å»ºæ–°çš„å¾…å“åº”é‚€è¯·
    const newInvitations = [
      {
        id: uuidv4(),
        project_id: projects.rows[0].id,
        worker_id: workerId,
        company_id: companyId,
        wage_offer: 380,
        wage_type: 'daily',
        message: 'æ€¥éœ€ç”µå·¥å¸ˆå‚…ï¼Œå¾…é‡ä¼˜åšï¼Œå·¥ä½œç¯å¢ƒè‰¯å¥½',
        status: 'pending',
        expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7å¤©åè¿‡æœŸ
      },
      {
        id: uuidv4(),
        project_id: projects.rows[1] ? projects.rows[1].id : projects.rows[0].id,
        worker_id: workerId,
        company_id: companyId,
        wage_offer: 65,
        wage_type: 'hourly',
        message: 'å•†åœºè£…ä¿®é¡¹ç›®ï¼Œéœ€è¦æœ‰ç»éªŒçš„æ°´ç”µå·¥ï¼Œé•¿æœŸåˆä½œä¼˜å…ˆ',
        status: 'pending',
        expires_at: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000) // 5å¤©åè¿‡æœŸ
      },
      {
        id: uuidv4(),
        project_id: projects.rows[2] ? projects.rows[2].id : projects.rows[0].id,
        worker_id: workerId,
        company_id: companyId,
        wage_offer: 3500,
        wage_type: 'fixed',
        message: 'åˆ«å¢…ç»´ä¿®é¡¹ç›®ï¼Œä¸€å£ä»·3500å…ƒï¼Œé¢„è®¡2-3å¤©å®Œæˆ',
        status: 'pending',
        expires_at: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000) // 3å¤©åè¿‡æœŸ
      }
    ];

    // æ’å…¥æ–°é‚€è¯·
    let successCount = 0;
    console.log('\nğŸ“ åˆ›å»ºæ–°é‚€è¯·:');
    
    for (const inv of newInvitations) {
      try {
        await pool.query(`
          INSERT INTO invitations (
            id, project_id, worker_id, company_id,
            wage_offer, wage_type, message, status,
            expires_at, sent_at, created_at
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
          ON CONFLICT (id) DO NOTHING
        `, [
          inv.id,
          inv.project_id,
          inv.worker_id,
          inv.company_id,
          inv.wage_offer,
          inv.wage_type,
          inv.message,
          inv.status,
          inv.expires_at
        ]);
        
        const project = projects.rows.find(p => p.id === inv.project_id);
        console.log(`âœ… åˆ›å»ºé‚€è¯·: ${project?.project_name || 'é¡¹ç›®'} - Â¥${inv.wage_offer}/${inv.wage_type === 'daily' ? 'å¤©' : inv.wage_type === 'hourly' ? 'å°æ—¶' : 'æ€»ä»·'}`);
        successCount++;
      } catch (error) {
        console.error(`âŒ åˆ›å»ºé‚€è¯·å¤±è´¥:`, error.message);
      }
    }

    // é‡æ–°ç»Ÿè®¡
    const finalStats = await pool.query(`
      SELECT 
        status,
        COUNT(*) as count
      FROM invitations
      WHERE worker_id = $1
      GROUP BY status
      ORDER BY 
        CASE status
          WHEN 'pending' THEN 1
          WHEN 'accepted' THEN 2
          WHEN 'rejected' THEN 3
          ELSE 4
        END
    `, [workerId]);
    
    console.log('\nğŸ“Š æ›´æ–°åçš„é‚€è¯·ç»Ÿè®¡:');
    console.table(finalStats.rows.map(row => ({
      çŠ¶æ€: row.status,
      æ•°é‡: row.count
    })));

    // è·å–å·²æ¥å—çš„å·¥ä½œï¼ˆjob_recordsï¼‰
    const jobRecords = await pool.query(`
      SELECT status, COUNT(*) as count
      FROM job_records
      WHERE worker_id = $1
      GROUP BY status
    `, [workerId]);
    
    if (jobRecords.rows.length > 0) {
      console.log('\nğŸ”§ å·¥ä½œè®°å½•çŠ¶æ€:');
      console.table(jobRecords.rows.map(row => ({
        çŠ¶æ€: row.status,
        æ•°é‡: row.count
      })));
    }

    console.log('\nğŸ‰ æ–°é‚€è¯·åˆ›å»ºå®Œæˆï¼');
    console.log('ğŸ“± ç°åœ¨å¯ä»¥ç”¨ 13800138001 / 123456 ç™»å½•æŸ¥çœ‹äº†');
    console.log('\nåœ¨å·¥ä½œé‚€è¯·é¡µé¢åº”è¯¥èƒ½çœ‹åˆ°:');
    console.log(`  - æ–°é‚€è¯·æ ‡ç­¾: ${finalStats.rows.find(r => r.status === 'pending')?.count || 0} ä¸ªå¾…å“åº”`);
    console.log(`  - å·²æ¥å—æ ‡ç­¾: æ˜¾ç¤ºjob_recordsä¸­çš„å·¥ä½œ`);

  } catch (error) {
    console.error('âŒ é”™è¯¯:', error.message);
  } finally {
    await pool.end();
  }
}

// æ‰§è¡Œ
createPendingInvitations();