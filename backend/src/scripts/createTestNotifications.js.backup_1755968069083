const { Pool } = require('pg');
require('dotenv').config({ path: require('path').join(__dirname, '../../.env') });

const pool = new Pool({
  host: process.env.DB_HOST || 'gz-postgres-peldbckv.sql.tencentcdb.com',
  port: process.env.DB_PORT || 23309,
  database: process.env.DB_NAME || 'blue_collar_platform',
  user: process.env.DB_USER || 'staffLink',
  password: process.env.DB_PASSWORD || 'SkzgEBg-23YbBpc',
  ssl: {
    rejectUnauthorized: false
  }
});

async function createTestNotifications() {
  try {
    console.log('ğŸ”” åˆ›å»ºæµ‹è¯•é€šçŸ¥...\n');
    
    // è·å–æµ‹è¯•ç”¨æˆ·
    const workers = await pool.query('SELECT id, name FROM workers LIMIT 3');
    const companies = await pool.query('SELECT id, company_name FROM companies LIMIT 1');
    
    if (workers.rows.length === 0 || companies.rows.length === 0) {
      console.log('âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•ç”¨æˆ·ï¼Œè¯·å…ˆåˆ›å»ºå·¥äººå’Œä¼ä¸šè´¦å·');
      return;
    }
    
    const workerId1 = workers.rows[0].id;
    const workerName1 = workers.rows[0].name;
    const companyId = companies.rows[0].id;
    const companyName = companies.rows[0].company_name;
    
    // å®šä¹‰æµ‹è¯•é€šçŸ¥
    const testNotifications = [
      // ç»™å·¥äººçš„é€šçŸ¥
      {
        receiver_id: workerId1,
        receiver_type: 'worker',
        sender_id: companyId,
        sender_type: 'company',
        type: 'invitation_received',
        title: 'æ–°å·¥ä½œæœºä¼š',
        message: `${companyName}é‚€è¯·æ‚¨å‚ä¸"åŠå…¬å®¤è£…ä¿®"é¡¹ç›®ï¼Œæ—¥è–ª300å…ƒ`,
        is_read: false,
        metadata: {
          companyName: companyName,
          projectName: 'åŠå…¬å®¤è£…ä¿®',
          wageOffer: 300,
          wageType: 'daily'
        }
      },
      {
        receiver_id: workerId1,
        receiver_type: 'worker',
        sender_id: companyId,
        sender_type: 'company',
        type: 'invitation_received',
        title: 'æ–°å·¥ä½œæœºä¼š',
        message: `${companyName}é‚€è¯·æ‚¨å‚ä¸"å¨æˆ¿æ”¹é€ "é¡¹ç›®ï¼Œæ—¶è–ª50å…ƒ`,
        is_read: false,
        metadata: {
          companyName: companyName,
          projectName: 'å¨æˆ¿æ”¹é€ ',
          wageOffer: 50,
          wageType: 'hourly'
        }
      },
      {
        receiver_id: workerId1,
        receiver_type: 'worker',
        sender_id: companyId,
        sender_type: 'company',
        type: 'project_started',
        title: 'é¡¹ç›®å³å°†å¼€å§‹',
        message: '"æ°´ç”µç»´ä¿®"é¡¹ç›®å°†åœ¨æ˜å¤©ä¸Šåˆ9:00å¼€å§‹ï¼Œè¯·å‡†æ—¶åˆ°è¾¾',
        is_read: false,
        metadata: {
          projectName: 'æ°´ç”µç»´ä¿®',
          startTime: '09:00',
          location: 'æœé˜³åŒºå»ºå›½è·¯88å·'
        }
      },
      {
        receiver_id: workerId1,
        receiver_type: 'worker',
        type: 'payment_received',
        title: 'å·¥èµ„åˆ°è´¦',
        message: 'æ‚¨çš„"åœ°æ¿å®‰è£…"é¡¹ç›®å·¥èµ„Â¥1500å·²åˆ°è´¦ï¼Œè¯·æŸ¥æ”¶',
        is_read: true,
        metadata: {
          projectName: 'åœ°æ¿å®‰è£…',
          amount: 1500,
          paymentMethod: 'é“¶è¡Œè½¬è´¦'
        }
      },
      {
        receiver_id: workerId1,
        receiver_type: 'worker',
        type: 'system',
        title: 'ç³»ç»Ÿé€šçŸ¥',
        message: 'æ–°åŠŸèƒ½ä¸Šçº¿ï¼šç°åœ¨å¯ä»¥åœ¨ä¸ªäººä¸­å¿ƒä¸Šä¼ èµ„è´¨è¯ä¹¦äº†',
        is_read: true,
        metadata: {
          feature: 'certificate_upload'
        }
      },
      
      // ç»™ä¼ä¸šçš„é€šçŸ¥
      {
        receiver_id: companyId,
        receiver_type: 'company',
        sender_id: workerId1,
        sender_type: 'worker',
        type: 'invitation_accepted',
        title: 'å·¥äººå·²ç¡®è®¤',
        message: `${workerName1}å·²ç¡®è®¤å‚ä¸"åŠå…¬å®¤è£…ä¿®"é¡¹ç›®`,
        is_read: false,
        metadata: {
          workerName: workerName1,
          projectName: 'åŠå…¬å®¤è£…ä¿®'
        }
      },
      {
        receiver_id: companyId,
        receiver_type: 'company',
        sender_id: workers.rows[1]?.id || workerId1,
        sender_type: 'worker',
        type: 'invitation_rejected',
        title: 'å·¥äººå·²æ‹’ç»',
        message: `${workers.rows[1]?.name || 'æå¸ˆå‚…'}æ‹’ç»äº†"å¨æˆ¿æ”¹é€ "é¡¹ç›®çš„é‚€è¯·`,
        is_read: false,
        metadata: {
          workerName: workers.rows[1]?.name || 'æå¸ˆå‚…',
          projectName: 'å¨æˆ¿æ”¹é€ ',
          reason: 'æ—¶é—´å†²çª'
        }
      }
    ];
    
    // æ’å…¥é€šçŸ¥
    for (const notification of testNotifications) {
      const insertQuery = `
        INSERT INTO notifications (
          receiver_id, receiver_type, sender_id, sender_type,
          type, title, message, is_read, metadata
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        RETURNING id, title, receiver_type;
      `;
      
      const values = [
        notification.receiver_id,
        notification.receiver_type,
        notification.sender_id || null,
        notification.sender_type || null,
        notification.type,
        notification.title,
        notification.message,
        notification.is_read,
        JSON.stringify(notification.metadata)
      ];
      
      const result = await pool.query(insertQuery, values);
      console.log(`âœ… åˆ›å»ºé€šçŸ¥: ${result.rows[0].title} (${result.rows[0].receiver_type})`);
    }
    
    // ç»Ÿè®¡é€šçŸ¥æ•°é‡
    const workerCount = await pool.query(
      'SELECT COUNT(*) as count FROM notifications WHERE receiver_id = $1 AND receiver_type = $2',
      [workerId1, 'worker']
    );
    
    const workerUnreadCount = await pool.query(
      'SELECT COUNT(*) as count FROM notifications WHERE receiver_id = $1 AND receiver_type = $2 AND is_read = false',
      [workerId1, 'worker']
    );
    
    const companyCount = await pool.query(
      'SELECT COUNT(*) as count FROM notifications WHERE receiver_id = $1 AND receiver_type = $2',
      [companyId, 'company']
    );
    
    const companyUnreadCount = await pool.query(
      'SELECT COUNT(*) as count FROM notifications WHERE receiver_id = $1 AND receiver_type = $2 AND is_read = false',
      [companyId, 'company']
    );
    
    console.log('\nğŸ“Š é€šçŸ¥ç»Ÿè®¡:');
    console.log(`å·¥äºº ${workerName1}:`);
    console.log(`  - æ€»é€šçŸ¥æ•°: ${workerCount.rows[0].count}`);
    console.log(`  - æœªè¯»é€šçŸ¥: ${workerUnreadCount.rows[0].count}`);
    console.log(`\nä¼ä¸š ${companyName}:`);
    console.log(`  - æ€»é€šçŸ¥æ•°: ${companyCount.rows[0].count}`);
    console.log(`  - æœªè¯»é€šçŸ¥: ${companyUnreadCount.rows[0].count}`);
    
    console.log('\nğŸ‰ æµ‹è¯•é€šçŸ¥åˆ›å»ºå®Œæˆï¼');
    console.log('\nğŸ’¡ æç¤º:');
    console.log('1. ä½¿ç”¨å·¥äººè´¦å·ç™»å½• App æŸ¥çœ‹é€šçŸ¥');
    console.log('2. æµ‹è¯•è´¦å·: 13800138001 / 123456');
    console.log('3. åœ¨ä¸ªäººä¸­å¿ƒç‚¹å‡»"æ¶ˆæ¯é€šçŸ¥"æŸ¥çœ‹');
    
  } catch (error) {
    console.error('âŒ åˆ›å»ºæµ‹è¯•é€šçŸ¥å¤±è´¥:', error.message);
  } finally {
    await pool.end();
  }
}

// è¿è¡Œè„šæœ¬
createTestNotifications();